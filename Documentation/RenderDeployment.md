# Развертывание на Render.com

Пошаговое руководство по развертыванию системы обновления плагинов Revit на Render.com.

## Предварительные требования

1. Аккаунт на [Render.com](https://render.com)
2. Репозиторий с кодом на GitHub/GitLab
3. Базовые знания Git

## Шаг 1: Подготовка репозитория

### 1.1 Создание репозитория
1. Создайте новый репозиторий на GitHub
2. Загрузите весь код проекта в репозиторий:

```bash
git init
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/ваш-username/revit-plugin-updater.git
git push -u origin main
```

### 1.2 Структура файлов
Убедитесь, что в корне репозитория есть:
- `Deployment/Dockerfile`
- `Deployment/render.yaml` (опционально)
- `Server/` - серверная часть
- `AdminPanel/` - веб-админка

## Шаг 2: Создание базы данных PostgreSQL

### 2.1 В Render Dashboard
1. Войдите в [Render Dashboard](https://dashboard.render.com)
2. Нажмите **"New +"** → **"PostgreSQL"**

### 2.2 Настройки базы данных
- **Name**: `revit-updater-db`
- **Database**: `revit_updater`
- **User**: `revit_user`
- **Region**: выберите ближайший регион (например, Oregon)
- **Plan**: **Free** (для начала)

### 2.3 Создание базы данных
1. Нажмите **"Create Database"**
2. Дождитесь создания (может занять несколько минут)
3. Сохраните **Connection String** - он понадобится позже

## Шаг 3: Создание Disk Volume для файлов

### 3.1 В Render Dashboard
1. Нажмите **"New +"** → **"Disk"**

### 3.2 Настройки диска
- **Name**: `plugin-files`
- **Size**: `1 GB` (для Free плана)
- **Region**: тот же, что и для базы данных

### 3.3 Создание диска
1. Нажмите **"Create Disk"**
2. Запомните имя диска для следующего шага

## Шаг 4: Создание Web Service

### 4.1 В Render Dashboard
1. Нажмите **"New +"** → **"Web Service"**

### 4.2 Подключение репозитория
1. Выберите **"Build and deploy from a Git repository"**
2. Подключите ваш GitHub аккаунт если еще не подключен
3. Выберите репозиторий с проектом

### 4.3 Основные настройки
- **Name**: `revit-plugin-updater`
- **Region**: тот же, что и база данных
- **Branch**: `main`
- **Runtime**: **Docker**
- **Dockerfile Path**: `./Deployment/Dockerfile`

### 4.4 План и настройки
- **Plan**: **Free** (для начала)
- **Auto-Deploy**: **Yes** (автоматическое развертывание при push)

## Шаг 5: Настройка переменных окружения

### 5.1 Environment Variables
В разделе **Environment Variables** добавьте:

```
ASPNETCORE_ENVIRONMENT = Production
ASPNETCORE_URLS = http://0.0.0.0:8080
PORT = 8080
```

### 5.2 Подключение базы данных
1. Нажмите **"Add from Database"**
2. Выберите созданную базу данных `revit-updater-db`
3. Выберите **"DATABASE_URL"**

### 5.3 Дополнительные переменные (опционально)
```
JwtSettings__SecretKey = ваш-секретный-ключ-минимум-32-символа
AdminCredentials__Username = admin
AdminCredentials__Password = ваш-пароль-админа
```

## Шаг 6: Подключение диска

### 6.1 В разделе Disk
1. Нажмите **"Add Disk"**
2. Выберите созданный диск `plugin-files`
3. **Mount Path**: `/var/data`

## Шаг 7: Развертывание

### 7.1 Создание сервиса
1. Нажмите **"Create Web Service"**
2. Render начнет сборку Docker образа
3. Процесс может занять 5-15 минут

### 7.2 Мониторинг развертывания
1. Следите за логами в разделе **"Logs"**
2. Дождитесь сообщения "Application started"
3. Статус должен стать **"Live"**

## Шаг 8: Проверка работоспособности

### 8.1 Проверка API
Откройте в браузере:
```
https://ваш-сервис.onrender.com/api/health
```

Должен вернуться JSON с информацией о состоянии сервера.

### 8.2 Проверка админки
Откройте:
```
https://ваш-сервис.onrender.com
```

Должна открыться страница авторизации админки.

### 8.3 Авторизация в админке
- **Username**: `admin` (или ваш из переменных)
- **Password**: `admin123` (или ваш из переменных)

## Шаг 9: Настройка домена (опционально)

### 9.1 Пользовательский домен
1. В настройках сервиса перейдите в **"Settings"**
2. В разделе **"Custom Domains"** нажмите **"Add"**
3. Введите ваш домен
4. Настройте DNS записи согласно инструкциям Render

## Шаг 10: Мониторинг и обслуживание

### 10.1 Логи
- Просматривайте логи в разделе **"Logs"**
- Настройте уведомления о проблемах

### 10.2 Метрики
- Следите за использованием ресурсов в **"Metrics"**
- При необходимости обновите план

### 10.3 Резервное копирование
- Render автоматически создает резервные копии PostgreSQL
- Настройте дополнительное резервное копирование файлов если нужно

## Возможные проблемы и решения

### Проблема: Ошибка подключения к базе данных
**Решение**: 
1. Проверьте правильность переменной `DATABASE_URL`
2. Убедитесь, что база данных создана и доступна
3. Проверьте логи на наличие ошибок подключения

### Проблема: Файлы не сохраняются
**Решение**:
1. Проверьте подключение диска в настройках сервиса
2. Убедитесь, что путь `/var/data` доступен для записи
3. Проверьте права доступа в Dockerfile

### Проблема: Медленная работа на Free плане
**Решение**:
1. Free план имеет ограничения по ресурсам
2. Рассмотрите обновление до Starter плана ($7/месяц)
3. Оптимизируйте код для уменьшения нагрузки

### Проблема: Сервис "засыпает"
**Решение**:
1. На Free плане сервисы засыпают после 15 минут неактивности
2. Обновитесь до платного плана для постоянной работы
3. Настройте внешний мониторинг для "пробуждения" сервиса

## Обновление приложения

### Автоматическое обновление
1. Сделайте изменения в коде
2. Выполните `git push` в основную ветку
3. Render автоматически пересоберет и развернет приложение

### Ручное обновление
1. В Render Dashboard перейдите к вашему сервису
2. Нажмите **"Manual Deploy"** → **"Deploy latest commit"**

## Масштабирование

### Обновление плана
1. **Starter** ($7/месяц): 0.5 CPU, 512 MB RAM
2. **Standard** ($25/месяц): 1 CPU, 2 GB RAM
3. **Pro** ($85/месяц): 2 CPU, 4 GB RAM

### Увеличение дискового пространства
1. В настройках диска можно увеличить размер
2. Стоимость: $0.25/GB в месяц

## Безопасность

### Рекомендации
1. Измените пароли по умолчанию
2. Используйте сложные JWT ключи
3. Настройте HTTPS (включено по умолчанию)
4. Регулярно обновляйте зависимости

### Мониторинг безопасности
1. Следите за логами на подозрительную активность
2. Настройте уведомления о неудачных попытках авторизации
3. Регулярно проверяйте список загруженных плагинов

## Поддержка

### Документация Render
- [Render Docs](https://render.com/docs)
- [Docker на Render](https://render.com/docs/docker)
- [PostgreSQL на Render](https://render.com/docs/databases)

### Сообщество
- [Render Community](https://community.render.com)
- [GitHub Issues](https://github.com/renderinc/render-examples)

Готово! Ваша система обновления плагинов Revit теперь развернута на Render.com и готова к использованию.