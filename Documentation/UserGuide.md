# Руководство пользователя

Полное руководство по использованию системы автоматического обновления плагинов Revit.

## Для администраторов

### Вход в админку

1. Откройте веб-браузер
2. Перейдите по адресу вашего сервера: `https://ваш-сервер.onrender.com`
3. Введите учетные данные:
   - **Логин**: `admin` (по умолчанию)
   - **Пароль**: `admin123` (по умолчанию)

### Дашборд

После входа вы увидите главную страницу с:
- **Статистикой**: количество плагинов, версий, общий размер файлов
- **Последними плагинами**: недавно добавленные или обновленные плагины

### Управление плагинами

#### Создание нового плагина

1. Перейдите в раздел **"Плагины"**
2. Нажмите **"Создать плагин"**
3. Заполните форму:
   - **Название**: понятное имя плагина
   - **Описание**: краткое описание функций
   - **Уникальный ID**: идентификатор для системы (например: `my-awesome-plugin`)
   - **Первая версия**: опционально загрузите файл первой версии

4. Нажмите **"Создать плагин"**

#### Загрузка новой версии

1. Перейдите в раздел **"Загрузить"**
2. Выберите плагин из списка
3. Укажите номер версии (например: `1.2.0`)
4. Добавьте описание изменений
5. Выберите файл плагина (поддерживаются: `.dll`, `.exe`, `.zip`, `.rar`)
6. Нажмите **"Загрузить версию"**

#### Удаление версии

1. В разделе **"Плагины"** найдите нужный плагин
2. В списке версий нажмите кнопку корзины рядом с версией
3. Подтвердите удаление

**⚠️ Внимание**: Удаление версии нельзя отменить!

### Мониторинг системы

#### Проверка состояния сервера

Откройте в браузере: `https://ваш-сервер.onrender.com/api/health`

Ответ должен содержать:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T12:00:00Z",
  "version": "1.0.0",
  "database": "connected",
  "uptime": 3600
}
```

#### Просмотр логов

На Render.com:
1. Войдите в Dashboard
2. Выберите ваш сервис
3. Перейдите в раздел **"Logs"**

## Для разработчиков плагинов

### Интеграция системы обновлений

#### 1. Добавление NuGet пакетов

В ваш проект Revit плагина добавьте:
```xml
<PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
<PackageReference Include="System.Net.Http" Version="4.3.4" />
```

#### 2. Копирование файлов клиента

Скопируйте из папки `RevitPlugin/` в ваш проект:
- `Models/`
- `Services/`
- `UpdateManager.cs`

#### 3. Настройка конфигурации

Создайте файл `UpdateConfig.json` в папке плагина:
```json
{
  "ServerUrl": "https://ваш-сервер.onrender.com",
  "PluginUniqueId": "ваш-уникальный-id",
  "CurrentVersion": "1.0.0",
  "CheckUpdatesOnStartup": true,
  "ShowNotifications": true,
  "AutoDownload": false,
  "AutoInstall": false,
  "CheckIntervalHours": 24,
  "MainPluginFile": "ВашПлагин.dll",
  "UpdaterPath": "updater.exe"
}
```

#### 4. Инициализация в плагине

```csharp
public class YourRevitPlugin : IExternalApplication
{
    private UpdateManager _updateManager;

    public Result OnStartup(UIControlledApplication application)
    {
        // Инициализация системы обновлений
        var pluginDir = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);
        _updateManager = new UpdateManager(pluginDir);

        // Настройка конфигурации
        var config = _updateManager.GetConfig();
        config.PluginUniqueId = "ваш-уникальный-id";
        config.MainPluginFile = "ВашПлагин.dll";
        config.ServerUrl = "https://ваш-сервер.onrender.com";
        _updateManager.SaveConfig(config);

        // Проверка обновлений при запуске
        Task.Run(async () => {
            await _updateManager.CheckForUpdatesOnStartupAsync();
        });

        return Result.Succeeded;
    }

    public Result OnShutdown(UIControlledApplication application)
    {
        _updateManager?.Dispose();
        return Result.Succeeded;
    }
}
```

#### 5. Создание updater.exe

1. Скомпилируйте проект `RevitPlugin/Updater/`
2. Скопируйте `updater.exe` в папку вашего плагина
3. Убедитесь, что путь в конфигурации правильный

### API для разработчиков

#### Проверка последней версии

```http
GET /api/plugins/by-unique-id/{uniqueId}/latest
```

Ответ:
```json
{
  "id": 1,
  "version": "1.2.0",
  "releaseNotes": "Исправлены ошибки...",
  "fileName": "plugin_v1.2.0.dll",
  "fileSize": 1048576,
  "fileHash": "abc123...",
  "createdAt": "2024-01-01T12:00:00Z"
}
```

#### Скачивание файла

```http
GET /api/download/by-unique-id/{uniqueId}/latest
```

Возвращает бинарный файл плагина.

#### Информация о плагине

```http
GET /api/plugins/by-unique-id/{uniqueId}
```

Возвращает полную информацию о плагине и всех версиях.

## Для пользователей Revit

### Автоматические обновления

Если плагин поддерживает систему обновлений:

1. **При запуске Revit** плагин автоматически проверит наличие обновлений
2. **При наличии обновления** появится уведомление с предложением скачать
3. **После скачивания** будет предложено установить обновление
4. **После установки** потребуется перезапуск Revit

### Ручная проверка обновлений

Если в плагине есть соответствующая кнопка:
1. Нажмите **"Проверить обновления"** в интерфейсе плагина
2. Дождитесь результата проверки
3. Следуйте инструкциям для скачивания и установки

### Настройки обновлений

Некоторые плагины позволяют настроить:
- **Автоматическую проверку** при запуске
- **Частоту проверки** обновлений
- **Автоматическое скачивание** новых версий
- **Показ уведомлений** о доступных обновлениях

### Устранение проблем

#### Обновление не скачивается

1. Проверьте подключение к интернету
2. Убедитесь, что сервер обновлений доступен
3. Проверьте настройки антивируса и брандмауэра
4. Попробуйте запустить Revit от имени администратора

#### Обновление не устанавливается

1. Закройте все экземпляры Revit
2. Убедитесь, что файлы плагина не заблокированы другими процессами
3. Проверьте права доступа к папке плагина
4. Попробуйте установить обновление вручную

#### Плагин не работает после обновления

1. Перезапустите Revit
2. Проверьте совместимость версии плагина с вашей версией Revit
3. Проверьте логи плагина в папке `Logs`
4. Обратитесь к разработчику плагина

## Безопасность

### Для администраторов

1. **Измените пароли по умолчанию** сразу после развертывания
2. **Проверяйте загружаемые файлы** на наличие вредоносного кода
3. **Ведите журнал** загрузок и скачиваний
4. **Регулярно обновляйте** систему

### Для разработчиков

1. **Подписывайте файлы плагинов** цифровой подписью
2. **Используйте HTTPS** для всех запросов к API
3. **Проверяйте хеши файлов** при скачивании
4. **Не включайте автоматическую установку** без согласия пользователя

### Для пользователей

1. **Скачивайте плагины** только из доверенных источников
2. **Проверяйте цифровые подписи** файлов
3. **Создавайте резервные копии** важных проектов перед обновлением плагинов
4. **Сообщайте о подозрительной активности** разработчикам

## Поддержка

### Логи и диагностика

Логи системы сохраняются в:
- **Сервер**: логи доступны в Render Dashboard
- **Клиент**: папка `Logs` в директории плагина

### Сообщение о проблемах

При обращении в поддержку укажите:
1. Версию Revit
2. Версию плагина
3. Описание проблемы
4. Шаги для воспроизведения
5. Содержимое логов (если возможно)

### Контакты

- **Email**: support@yourcompany.com
- **GitHub Issues**: https://github.com/yourcompany/revit-plugin-updater/issues
- **Документация**: https://docs.yourcompany.com

## Часто задаваемые вопросы

### В: Можно ли использовать систему для нескольких плагинов?
О: Да, один сервер может обслуживать множество плагинов. Каждый плагин должен иметь уникальный ID.

### В: Поддерживаются ли разные версии Revit?
О: Да, но каждая версия Revit может требовать отдельную сборку плагина.

### В: Можно ли откатить обновление?
О: Система создает резервные копии, но автоматический откат не поддерживается. Обратитесь к разработчику плагина.

### В: Безопасно ли автоматическое обновление?
О: Рекомендуется отключить автоматическую установку и проверять обновления вручную.

### В: Работает ли система без интернета?
О: Нет, для проверки и скачивания обновлений требуется подключение к интернету.

### В: Можно ли использовать собственный сервер?
О: Да, код открытый и может быть развернут на любом сервере с поддержкой ASP.NET Core и PostgreSQL.